
LIBRARY IEEE;
USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;
USE work.echo_pkg.ALL;

ENTITY flanger IS
  PORT( clk                               :   IN    std_logic;
        reset                             :   IN    std_logic;
        clk_enable                        :   IN    std_logic;
        In1                               :   IN    std_logic_vector(7 DOWNTO 0);  -- int8
        ce_out                            :   OUT   std_logic;
        Out1                              :   OUT   std_logic_vector(7 DOWNTO 0)  -- int8
        );
END flanger;


ARCHITECTURE rtl OF flanger IS

  -- Signals
  SIGNAL enb                              : std_logic;
  SIGNAL In1_signed                       : signed(7 DOWNTO 0);  -- int8
  SIGNAL Delay_reg                        : vector_of_signed8(0 TO 639);  -- sfix8 [6000]
  SIGNAL Delay_out1                       : signed(7 DOWNTO 0);  -- int8
  SIGNAL attenuation_cast                 : signed(15 DOWNTO 0);  -- sfix16_En7
  SIGNAL attenuation_out1                 : signed(7 DOWNTO 0);  -- int8
  SIGNAL Sum_out1                         : signed(7 DOWNTO 0);  -- int8
  SIGNAL sin_pos											: INTEGER RANGE 0 TO 50;

BEGIN
  In1_signed <= signed(In1);

  enb <= clk_enable;

  Delay_process : PROCESS (clk, reset)
  VARIABLE count1  :  INTEGER RANGE 0 TO 100 := 0;  --timing for clock generation
  VARIABLE count2  :  INTEGER RANGE 0 TO 639 := 0;
  BEGIN
    IF reset = '1' THEN
      Delay_reg <= (OTHERS => to_signed(16#00#, 8));
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
			IF(count1 < 100) THEN
				count1 := count1 + 1;
			ELSIF THEN
				count1 := 0;
				IF(count2 < 639) THEN
					count2 := count2 + 2;
				ELSIF THEN
					count2 := 0;
				END IF
			END IF
			CASE count2 IS
				WHEN  0  =>
					 sin_pos <= 320 ;
				WHEN  1  =>
					 sin_pos <= 326 ;
				WHEN  2  =>
					 sin_pos <= 332 ;
				WHEN  3  =>
					 sin_pos <= 338 ;
				WHEN  4  =>
					 sin_pos <= 345 ;
				WHEN  5  =>
					 sin_pos <= 351 ;
				WHEN  6  =>
					 sin_pos <= 357 ;
				WHEN  7  =>
					 sin_pos <= 363 ;
				WHEN  8  =>
					 sin_pos <= 370 ;
				WHEN  9  =>
					 sin_pos <= 376 ;
				WHEN  10  =>
					 sin_pos <= 382 ;
				WHEN  11  =>
					 sin_pos <= 388 ;
				WHEN  12  =>
					 sin_pos <= 394 ;
				WHEN  13  =>
					 sin_pos <= 400 ;
				WHEN  14  =>
					 sin_pos <= 406 ;
				WHEN  15  =>
					 sin_pos <= 412 ;
				WHEN  16  =>
					 sin_pos <= 418 ;
				WHEN  17  =>
					 sin_pos <= 424 ;
				WHEN  18  =>
					 sin_pos <= 430 ;
				WHEN  19  =>
					 sin_pos <= 436 ;
				WHEN  20  =>
					 sin_pos <= 442 ;
				WHEN  21  =>
					 sin_pos <= 448 ;
				WHEN  22  =>
					 sin_pos <= 453 ;
				WHEN  23  =>
					 sin_pos <= 459 ;
				WHEN  24  =>
					 sin_pos <= 465 ;
				WHEN  25  =>
					 sin_pos <= 470 ;
				WHEN  26  =>
					 sin_pos <= 476 ;
				WHEN  27  =>
					 sin_pos <= 481 ;
				WHEN  28  =>
					 sin_pos <= 487 ;
				WHEN  29  =>
					 sin_pos <= 492 ;
				WHEN  30  =>
					 sin_pos <= 497 ;
				WHEN  31  =>
					 sin_pos <= 502 ;
				WHEN  32  =>
					 sin_pos <= 508 ;
				WHEN  33  =>
					 sin_pos <= 513 ;
				WHEN  34  =>
					 sin_pos <= 518 ;
				WHEN  35  =>
					 sin_pos <= 523 ;
				WHEN  36  =>
					 sin_pos <= 527 ;
				WHEN  37  =>
					 sin_pos <= 532 ;
				WHEN  38  =>
					 sin_pos <= 537 ;
				WHEN  39  =>
					 sin_pos <= 541 ;
				WHEN  40  =>
					 sin_pos <= 546 ;
				WHEN  41  =>
					 sin_pos <= 550 ;
				WHEN  42  =>
					 sin_pos <= 554 ;
				WHEN  43  =>
					 sin_pos <= 559 ;
				WHEN  44  =>
					 sin_pos <= 563 ;
				WHEN  45  =>
					 sin_pos <= 567 ;
				WHEN  46  =>
					 sin_pos <= 571 ;
				WHEN  47  =>
					 sin_pos <= 575 ;
				WHEN  48  =>
					 sin_pos <= 578 ;
				WHEN  49  =>
					 sin_pos <= 582 ;
				WHEN  50  =>
					 sin_pos <= 586 ;
				WHEN  51  =>
					 sin_pos <= 589 ;
				WHEN  52  =>
					 sin_pos <= 592 ;
				WHEN  53  =>
					 sin_pos <= 596 ;
				WHEN  54  =>
					 sin_pos <= 599 ;
				WHEN  55  =>
					 sin_pos <= 602 ;
				WHEN  56  =>
					 sin_pos <= 605 ;
				WHEN  57  =>
					 sin_pos <= 607 ;
				WHEN  58  =>
					 sin_pos <= 610 ;
				WHEN  59  =>
					 sin_pos <= 613 ;
				WHEN  60  =>
					 sin_pos <= 615 ;
				WHEN  61  =>
					 sin_pos <= 617 ;
				WHEN  62  =>
					 sin_pos <= 620 ;
				WHEN  63  =>
					 sin_pos <= 622 ;
				WHEN  64  =>
					 sin_pos <= 624 ;
				WHEN  65  =>
					 sin_pos <= 626 ;
				WHEN  66  =>
					 sin_pos <= 627 ;
				WHEN  67  =>
					 sin_pos <= 629 ;
				WHEN  68  =>
					 sin_pos <= 631 ;
				WHEN  69  =>
					 sin_pos <= 632 ;
				WHEN  70  =>
					 sin_pos <= 633 ;
				WHEN  71  =>
					 sin_pos <= 635 ;
				WHEN  72  =>
					 sin_pos <= 636 ;
				WHEN  73  =>
					 sin_pos <= 636 ;
				WHEN  74  =>
					 sin_pos <= 637 ;
				WHEN  75  =>
					 sin_pos <= 638 ;
				WHEN  76  =>
					 sin_pos <= 639 ;
				WHEN  77  =>
					 sin_pos <= 639 ;
				WHEN  78  =>
					 sin_pos <= 639 ;
				WHEN  79  =>
					 sin_pos <= 639 ;
				WHEN  80  =>
					 sin_pos <= 640 ;
				WHEN  81  =>
					 sin_pos <= 639 ;
				WHEN  82  =>
					 sin_pos <= 639 ;
				WHEN  83  =>
					 sin_pos <= 639 ;
				WHEN  84  =>
					 sin_pos <= 639 ;
				WHEN  85  =>
					 sin_pos <= 638 ;
				WHEN  86  =>
					 sin_pos <= 637 ;
				WHEN  87  =>
					 sin_pos <= 636 ;
				WHEN  88  =>
					 sin_pos <= 636 ;
				WHEN  89  =>
					 sin_pos <= 635 ;
				WHEN  90  =>
					 sin_pos <= 633 ;
				WHEN  91  =>
					 sin_pos <= 632 ;
				WHEN  92  =>
					 sin_pos <= 631 ;
				WHEN  93  =>
					 sin_pos <= 629 ;
				WHEN  94  =>
					 sin_pos <= 627 ;
				WHEN  95  =>
					 sin_pos <= 626 ;
				WHEN  96  =>
					 sin_pos <= 624 ;
				WHEN  97  =>
					 sin_pos <= 622 ;
				WHEN  98  =>
					 sin_pos <= 620 ;
				WHEN  99  =>
					 sin_pos <= 617 ;
				WHEN  100  =>
					 sin_pos <= 615 ;
				WHEN  101  =>
					 sin_pos <= 613 ;
				WHEN  102  =>
					 sin_pos <= 610 ;
				WHEN  103  =>
					 sin_pos <= 607 ;
				WHEN  104  =>
					 sin_pos <= 605 ;
				WHEN  105  =>
					 sin_pos <= 602 ;
				WHEN  106  =>
					 sin_pos <= 599 ;
				WHEN  107  =>
					 sin_pos <= 596 ;
				WHEN  108  =>
					 sin_pos <= 592 ;
				WHEN  109  =>
					 sin_pos <= 589 ;
				WHEN  110  =>
					 sin_pos <= 586 ;
				WHEN  111  =>
					 sin_pos <= 582 ;
				WHEN  112  =>
					 sin_pos <= 578 ;
				WHEN  113  =>
					 sin_pos <= 575 ;
				WHEN  114  =>
					 sin_pos <= 571 ;
				WHEN  115  =>
					 sin_pos <= 567 ;
				WHEN  116  =>
					 sin_pos <= 563 ;
				WHEN  117  =>
					 sin_pos <= 559 ;
				WHEN  118  =>
					 sin_pos <= 554 ;
				WHEN  119  =>
					 sin_pos <= 550 ;
				WHEN  120  =>
					 sin_pos <= 546 ;
				WHEN  121  =>
					 sin_pos <= 541 ;
				WHEN  122  =>
					 sin_pos <= 537 ;
				WHEN  123  =>
					 sin_pos <= 532 ;
				WHEN  124  =>
					 sin_pos <= 527 ;
				WHEN  125  =>
					 sin_pos <= 523 ;
				WHEN  126  =>
					 sin_pos <= 518 ;
				WHEN  127  =>
					 sin_pos <= 513 ;
				WHEN  128  =>
					 sin_pos <= 508 ;
				WHEN  129  =>
					 sin_pos <= 502 ;
				WHEN  130  =>
					 sin_pos <= 497 ;
				WHEN  131  =>
					 sin_pos <= 492 ;
				WHEN  132  =>
					 sin_pos <= 487 ;
				WHEN  133  =>
					 sin_pos <= 481 ;
				WHEN  134  =>
					 sin_pos <= 476 ;
				WHEN  135  =>
					 sin_pos <= 470 ;
				WHEN  136  =>
					 sin_pos <= 465 ;
				WHEN  137  =>
					 sin_pos <= 459 ;
				WHEN  138  =>
					 sin_pos <= 453 ;
				WHEN  139  =>
					 sin_pos <= 448 ;
				WHEN  140  =>
					 sin_pos <= 442 ;
				WHEN  141  =>
					 sin_pos <= 436 ;
				WHEN  142  =>
					 sin_pos <= 430 ;
				WHEN  143  =>
					 sin_pos <= 424 ;
				WHEN  144  =>
					 sin_pos <= 418 ;
				WHEN  145  =>
					 sin_pos <= 412 ;
				WHEN  146  =>
					 sin_pos <= 406 ;
				WHEN  147  =>
					 sin_pos <= 400 ;
				WHEN  148  =>
					 sin_pos <= 394 ;
				WHEN  149  =>
					 sin_pos <= 388 ;
				WHEN  150  =>
					 sin_pos <= 382 ;
				WHEN  151  =>
					 sin_pos <= 376 ;
				WHEN  152  =>
					 sin_pos <= 370 ;
				WHEN  153  =>
					 sin_pos <= 363 ;
				WHEN  154  =>
					 sin_pos <= 357 ;
				WHEN  155  =>
					 sin_pos <= 351 ;
				WHEN  156  =>
					 sin_pos <= 345 ;
				WHEN  157  =>
					 sin_pos <= 338 ;
				WHEN  158  =>
					 sin_pos <= 332 ;
				WHEN  159  =>
					 sin_pos <= 326 ;
				WHEN  160  =>
					 sin_pos <= 320 ;
				WHEN  161  =>
					 sin_pos <= 313 ;
				WHEN  162  =>
					 sin_pos <= 307 ;
				WHEN  163  =>
					 sin_pos <= 301 ;
				WHEN  164  =>
					 sin_pos <= 294 ;
				WHEN  165  =>
					 sin_pos <= 288 ;
				WHEN  166  =>
					 sin_pos <= 282 ;
				WHEN  167  =>
					 sin_pos <= 276 ;
				WHEN  168  =>
					 sin_pos <= 269 ;
				WHEN  169  =>
					 sin_pos <= 263 ;
				WHEN  170  =>
					 sin_pos <= 257 ;
				WHEN  171  =>
					 sin_pos <= 251 ;
				WHEN  172  =>
					 sin_pos <= 245 ;
				WHEN  173  =>
					 sin_pos <= 239 ;
				WHEN  174  =>
					 sin_pos <= 233 ;
				WHEN  175  =>
					 sin_pos <= 227 ;
				WHEN  176  =>
					 sin_pos <= 221 ;
				WHEN  177  =>
					 sin_pos <= 215 ;
				WHEN  178  =>
					 sin_pos <= 209 ;
				WHEN  179  =>
					 sin_pos <= 203 ;
				WHEN  180  =>
					 sin_pos <= 197 ;
				WHEN  181  =>
					 sin_pos <= 191 ;
				WHEN  182  =>
					 sin_pos <= 186 ;
				WHEN  183  =>
					 sin_pos <= 180 ;
				WHEN  184  =>
					 sin_pos <= 174 ;
				WHEN  185  =>
					 sin_pos <= 169 ;
				WHEN  186  =>
					 sin_pos <= 163 ;
				WHEN  187  =>
					 sin_pos <= 158 ;
				WHEN  188  =>
					 sin_pos <= 152 ;
				WHEN  189  =>
					 sin_pos <= 147 ;
				WHEN  190  =>
					 sin_pos <= 142 ;
				WHEN  191  =>
					 sin_pos <= 137 ;
				WHEN  192  =>
					 sin_pos <= 131 ;
				WHEN  193  =>
					 sin_pos <= 126 ;
				WHEN  194  =>
					 sin_pos <= 121 ;
				WHEN  195  =>
					 sin_pos <= 116 ;
				WHEN  196  =>
					 sin_pos <= 112 ;
				WHEN  197  =>
					 sin_pos <= 107 ;
				WHEN  198  =>
					 sin_pos <= 102 ;
				WHEN  199  =>
					 sin_pos <= 98 ;
				WHEN  200  =>
					 sin_pos <= 93 ;
				WHEN  201  =>
					 sin_pos <= 89 ;
				WHEN  202  =>
					 sin_pos <= 85 ;
				WHEN  203  =>
					 sin_pos <= 80 ;
				WHEN  204  =>
					 sin_pos <= 76 ;
				WHEN  205  =>
					 sin_pos <= 72 ;
				WHEN  206  =>
					 sin_pos <= 68 ;
				WHEN  207  =>
					 sin_pos <= 64 ;
				WHEN  208  =>
					 sin_pos <= 61 ;
				WHEN  209  =>
					 sin_pos <= 57 ;
				WHEN  210  =>
					 sin_pos <= 53 ;
				WHEN  211  =>
					 sin_pos <= 50 ;
				WHEN  212  =>
					 sin_pos <= 47 ;
				WHEN  213  =>
					 sin_pos <= 43 ;
				WHEN  214  =>
					 sin_pos <= 40 ;
				WHEN  215  =>
					 sin_pos <= 37 ;
				WHEN  216  =>
					 sin_pos <= 34 ;
				WHEN  217  =>
					 sin_pos <= 32 ;
				WHEN  218  =>
					 sin_pos <= 29 ;
				WHEN  219  =>
					 sin_pos <= 26 ;
				WHEN  220  =>
					 sin_pos <= 24 ;
				WHEN  221  =>
					 sin_pos <= 22 ;
				WHEN  222  =>
					 sin_pos <= 19 ;
				WHEN  223  =>
					 sin_pos <= 17 ;
				WHEN  224  =>
					 sin_pos <= 15 ;
				WHEN  225  =>
					 sin_pos <= 13 ;
				WHEN  226  =>
					 sin_pos <= 12 ;
				WHEN  227  =>
					 sin_pos <= 10 ;
				WHEN  228  =>
					 sin_pos <= 8 ;
				WHEN  229  =>
					 sin_pos <= 7 ;
				WHEN  230  =>
					 sin_pos <= 6 ;
				WHEN  231  =>
					 sin_pos <= 4 ;
				WHEN  232  =>
					 sin_pos <= 3 ;
				WHEN  233  =>
					 sin_pos <= 3 ;
				WHEN  234  =>
					 sin_pos <= 2 ;
				WHEN  235  =>
					 sin_pos <= 1 ;
				WHEN  236  =>
					 sin_pos <= 0 ;
				WHEN  237  =>
					 sin_pos <= 0 ;
				WHEN  238  =>
					 sin_pos <= 0 ;
				WHEN  239  =>
					 sin_pos <= 0 ;
				WHEN  240  =>
					 sin_pos <= 0 ;
				WHEN  241  =>
					 sin_pos <= 0 ;
				WHEN  242  =>
					 sin_pos <= 0 ;
				WHEN  243  =>
					 sin_pos <= 0 ;
				WHEN  244  =>
					 sin_pos <= 0 ;
				WHEN  245  =>
					 sin_pos <= 1 ;
				WHEN  246  =>
					 sin_pos <= 2 ;
				WHEN  247  =>
					 sin_pos <= 3 ;
				WHEN  248  =>
					 sin_pos <= 3 ;
				WHEN  249  =>
					 sin_pos <= 4 ;
				WHEN  250  =>
					 sin_pos <= 6 ;
				WHEN  251  =>
					 sin_pos <= 7 ;
				WHEN  252  =>
					 sin_pos <= 8 ;
				WHEN  253  =>
					 sin_pos <= 10 ;
				WHEN  254  =>
					 sin_pos <= 12 ;
				WHEN  255  =>
					 sin_pos <= 13 ;
				WHEN  256  =>
					 sin_pos <= 15 ;
				WHEN  257  =>
					 sin_pos <= 17 ;
				WHEN  258  =>
					 sin_pos <= 19 ;
				WHEN  259  =>
					 sin_pos <= 22 ;
				WHEN  260  =>
					 sin_pos <= 24 ;
				WHEN  261  =>
					 sin_pos <= 26 ;
				WHEN  262  =>
					 sin_pos <= 29 ;
				WHEN  263  =>
					 sin_pos <= 32 ;
				WHEN  264  =>
					 sin_pos <= 34 ;
				WHEN  265  =>
					 sin_pos <= 37 ;
				WHEN  266  =>
					 sin_pos <= 40 ;
				WHEN  267  =>
					 sin_pos <= 43 ;
				WHEN  268  =>
					 sin_pos <= 47 ;
				WHEN  269  =>
					 sin_pos <= 50 ;
				WHEN  270  =>
					 sin_pos <= 53 ;
				WHEN  271  =>
					 sin_pos <= 57 ;
				WHEN  272  =>
					 sin_pos <= 61 ;
				WHEN  273  =>
					 sin_pos <= 64 ;
				WHEN  274  =>
					 sin_pos <= 68 ;
				WHEN  275  =>
					 sin_pos <= 72 ;
				WHEN  276  =>
					 sin_pos <= 76 ;
				WHEN  277  =>
					 sin_pos <= 80 ;
				WHEN  278  =>
					 sin_pos <= 85 ;
				WHEN  279  =>
					 sin_pos <= 89 ;
				WHEN  280  =>
					 sin_pos <= 93 ;
				WHEN  281  =>
					 sin_pos <= 98 ;
				WHEN  282  =>
					 sin_pos <= 102 ;
				WHEN  283  =>
					 sin_pos <= 107 ;
				WHEN  284  =>
					 sin_pos <= 112 ;
				WHEN  285  =>
					 sin_pos <= 116 ;
				WHEN  286  =>
					 sin_pos <= 121 ;
				WHEN  287  =>
					 sin_pos <= 126 ;
				WHEN  288  =>
					 sin_pos <= 131 ;
				WHEN  289  =>
					 sin_pos <= 137 ;
				WHEN  290  =>
					 sin_pos <= 142 ;
				WHEN  291  =>
					 sin_pos <= 147 ;
				WHEN  292  =>
					 sin_pos <= 152 ;
				WHEN  293  =>
					 sin_pos <= 158 ;
				WHEN  294  =>
					 sin_pos <= 163 ;
				WHEN  295  =>
					 sin_pos <= 169 ;
				WHEN  296  =>
					 sin_pos <= 174 ;
				WHEN  297  =>
					 sin_pos <= 180 ;
				WHEN  298  =>
					 sin_pos <= 186 ;
				WHEN  299  =>
					 sin_pos <= 191 ;
				WHEN  300  =>
					 sin_pos <= 197 ;
				WHEN  301  =>
					 sin_pos <= 203 ;
				WHEN  302  =>
					 sin_pos <= 209 ;
				WHEN  303  =>
					 sin_pos <= 215 ;
				WHEN  304  =>
					 sin_pos <= 221 ;
				WHEN  305  =>
					 sin_pos <= 227 ;
				WHEN  306  =>
					 sin_pos <= 233 ;
				WHEN  307  =>
					 sin_pos <= 239 ;
				WHEN  308  =>
					 sin_pos <= 245 ;
				WHEN  309  =>
					 sin_pos <= 251 ;
				WHEN  310  =>
					 sin_pos <= 257 ;
				WHEN  311  =>
					 sin_pos <= 263 ;
				WHEN  312  =>
					 sin_pos <= 269 ;
				WHEN  313  =>
					 sin_pos <= 276 ;
				WHEN  314  =>
					 sin_pos <= 282 ;
				WHEN  315  =>
					 sin_pos <= 288 ;
				WHEN  316  =>
					 sin_pos <= 294 ;
				WHEN  317  =>
					 sin_pos <= 301 ;
				WHEN  318  =>
					 sin_pos <= 307 ;
				WHEN  319  =>
					 sin_pos <= 313 ;
				WHEN OTHERS =>	 
					sin_pos <= 0;
			END CASE;
			
			Delay_reg(0) <= In1_signed;
			Delay_reg(1 TO 639) <= Delay_reg(0 TO 638);
      END IF;
    END IF;
  END PROCESS Delay_process;

  Delay_out1 <= Delay_reg(5999);

  attenuation_cast <= resize(Delay_out1 & '0' & '0' & '0' & '0' & '0' & '0', 16);
  attenuation_out1 <= attenuation_cast(14 DOWNTO 7) + ('0' & (attenuation_cast(6) AND (( NOT attenuation_cast(15)) OR (attenuation_cast(5) OR attenuation_cast(4) OR attenuation_cast(3) OR attenuation_cast(2) OR attenuation_cast(1) OR attenuation_cast(0)))));

  Sum_out1 <= In1_signed + attenuation_out1;

  Out1 <= std_logic_vector(Sum_out1);

  ce_out <= clk_enable;

END rtl;

